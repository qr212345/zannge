<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ババ抜き大会管理</title>
  <style>
    /* ====== CSS スタイル ====== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 10px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 5px;
    }
    #messageArea {
      text-align: center;
      padding: 5px;
      margin-bottom: 10px;
      background: #eef;
      border-radius: 5px;
      min-height: 24px;
      font-weight: bold;
      color: #004;
    }
    #navButtons {
      text-align: center;
      margin-bottom: 10px;
    }
    #navButtons button {
      margin: 0 5px;
      padding: 8px 15px;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #777;
      border-radius: 5px;
      background-color: #ddd;
      transition: background-color 0.3s ease;
    }
    #navButtons button:hover {
      background-color: #bbb;
    }
    /* カメラ表示領域 */
    #reader, #rankingReader {
      width: 320px;
      height: 320px;
      margin: 10px auto;
      border: 2px solid #555;
      border-radius: 8px;
      background-color: #222;
    }
    /* 座席一覧 */
    #seatList {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .seat-block {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 6px #ccc;
      min-width: 280px;
      max-width: 300px;
    }
    .seat-block h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .remove-button {
      color: red;
      font-weight: bold;
      cursor: pointer;
    }
    .player-entry {
      border-top: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .title-badge {
      margin-left: 6px;
      font-weight: bold;
      font-size: 0.8rem;
      padding: 2px 5px;
      border-radius: 4px;
      color: white;
    }
    .title-👑\ 王者 {
      background-color: gold;
    }
    .title-🥈\ 挑戦者 {
      background-color: silver;
    }
    .title-🥉\ 鬼気迫る者 {
      background-color: #cd7f32;
    }
    .rate-change {
      margin-left: 10px;
      font-weight: bold;
    }
    .rate-up {
      color: green;
    }
    .rate-down {
      color: red;
    }
    .rate-zero {
      color: gray;
    }
    /* 順位登録セクション */
    #rankingSection {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #rankingList {
      list-style: none;
      padding: 0;
      margin: 10px auto;
      width: 280px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 6px #ccc;
      min-height: 50px;
    }
    #rankingList li {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      cursor: grab;
      user-select: none;
    }
    #rankingList li:last-child {
      border-bottom: none;
    }
    #rankingList li.dragging {
      opacity: 0.5;
    }
    /* 操作ボタン */
    #actionButtons {
      margin-top: 10px;
      text-align: center;
    }
    #actionButtons button {
      margin: 0 7px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #4285f4;
      color: white;
      transition: background-color 0.3s ease;
    }
    #actionButtons button:hover {
      background-color: #3367d6;
    }
  </style>
</head>
<body>
  <h1>ババ抜き大会管理</h1>
  <div id="messageArea"></div>

  <div id="navButtons">
    <button>スキャンモード</button>
    <button>順位登録モード</button>
    <button>元に戻す (Undo)</button>
  </div>

  <!-- スキャンモード -->
  <section id="scanSection">
    <div id="reader"></div>
    <div id="seatList"></div>
  </section>

  <!-- 順位登録モード -->
  <section id="rankingSection">
    <div id="rankingReader"></div>
    <ul id="rankingList"></ul>
    <div id="actionButtons">
      <button>順位確定</button>
      <button>戻る</button>
    </div>
  </section>

  <!-- html5-qrcode ライブラリ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyItVPS9GN4ePrx6Jj20WagXRq2z73wEKOPKEn6dImrovIAwXoersSwUixxUJSpddU/exec';
    const POLL_INTERVAL_MS = 20000;
    const SCAN_COOLDOWN_MS = 1500;

    let pollTimer = null;
    let isSaving = false;
    let qrReader = null;
    let rankingQrReader = null;
    let qrActive = false;
    let rankingQrActive = false;
    let isRankingMode = false;
    let currentSeatId = null;
    let rankingSeatId = null;
    let lastScanTime = 0;
    let lastScannedText = '';
    let seatMap = {};
    let playerData = {};
    let actionHistory = [];
    let msgTimer = null;

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function displayMessage(msg) {
      const area = document.getElementById('messageArea');
      if (!area) return;
      area.textContent = msg;
      clearTimeout(msgTimer);
      msgTimer = setTimeout(() => { area.textContent = ''; }, 3000);
    }

    async function stopCamera() {
      if (qrReader && qrActive) {
        await qrReader.stop();
        qrReader.clear();
        qrReader = null;
        qrActive = false;
      }
    }

    async function stopRankingCamera() {
      if (rankingQrReader && rankingQrActive) {
        await rankingQrReader.stop();
        rankingQrReader.clear();
        rankingQrReader = null;
        rankingQrActive = false;
      }
    }

    async function stopAllCameras() {
      await stopCamera();
      await stopRankingCamera();
    }

    async function initCamera() {
      const qrRegion = document.getElementById('reader');
      if (!qrRegion) return;

      if (typeof Html5Qrcode === 'undefined') {
        console.error("Html5Qrcodeが読み込まれていません");
        displayMessage("QRコードライブラリの読み込みに失敗しました");
        return;
      }

      await stopAllCameras();

      try {
        qrReader = new Html5Qrcode("reader");
        await qrReader.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            handleScanSuccess(qrCodeMessage);
          },
          errorMessage => {}
        );
        qrActive = true;
        displayMessage('📷 カメラ起動中（スキャンモード）');
      } catch (err) {
        console.error("QRコード初期化エラー:", err);
        displayMessage("❌ カメラ起動に失敗しました");
      }
    }

    async function startRankingCamera() {
      if (rankingQrActive) return;

      await stopAllCameras();

      rankingQrReader = new Html5Qrcode('rankingReader');
      rankingQrReader.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        decodedText => {
          if (decodedText.startsWith('table')) {
            rankingSeatId = decodedText;
            displayMessage(`✅ 座席 ${decodedText} 読み取り成功`);
            populateRankingList(rankingSeatId);
          } else if (decodedText.startsWith('player')) {
            handleRankingMode(decodedText);
          } else {
            displayMessage('⚠ 座席またはプレイヤーQRのみ有効です');
          }
        },
        errorMessage => {}
      ).then(() => {
        rankingQrActive = true;
        displayMessage('📷 カメラ起動中（順位登録モード）');
      }).catch(err => {
        console.error(err);
        displayMessage('❌ 順位登録用カメラ起動失敗');
      });
    }

    function handleScanSuccess(decodedText) {
      const now = Date.now();
      if (decodedText === lastScannedText && now - lastScanTime < SCAN_COOLDOWN_MS) {
        return;
      }
      lastScannedText = decodedText;
      lastScanTime = now;

      if (decodedText.startsWith('table')) {
        currentSeatId = decodedText;
        if (!seatMap[currentSeatId]) seatMap[currentSeatId] = [];
        displayMessage(`✅ 座席セット: ${currentSeatId}`);
      } else if (decodedText.startsWith('player')) {
        if (!currentSeatId) {
          displayMessage('⚠ 先に座席QRを読み込んでください');
          return;
        }
        if (seatMap[currentSeatId].includes(decodedText)) {
          displayMessage('⚠ 既に登録済みのプレイヤーです');
          return;
        }
        if (seatMap[currentSeatId].length >= 6) {
          displayMessage('⚠ この座席は6人まで登録可能です');
          return;
        }

        seatMap[currentSeatId].push(decodedText);
        playerData[decodedText] ??= { nickname: decodedText, rate: 50, lastRank: null, bonus: 0, title: null };
        actionHistory.push({ type: 'addPlayer', seatId: currentSeatId, playerId: decodedText });
        saveActionHistory();
        displayMessage(`✅ プレイヤー追加: ${decodedText}`);
        saveToLocalStorage();
        renderSeats();
      }
    }

    function handleRankingMode(decodedText) {
      if (!rankingSeatId) {
        displayMessage('⚠ 先に座席QRを読み込んでください（順位登録モード）');
        return;
      }
      if (!decodedText.startsWith('player')) {
        displayMessage('⚠ プレイヤーQRコードのみ有効です');
        return;
      }

      const players = seatMap[rankingSeatId] || [];
      if (players.includes(decodedText)) {
        displayMessage('⚠ 既に登録済みのプレイヤーです');
        return;
      }
      if (players.length >= 6) {
        displayMessage('⚠ この座席は6人まで登録可能です');
        return;
      }

      players.push(decodedText);
      seatMap[rankingSeatId] = players;

      playerData[decodedText] ??= { nickname: decodedText, rate: 50, lastRank: null, bonus: 0, title: null };
      actionHistory.push({ type: 'addPlayer', seatId: rankingSeatId, playerId: decodedText });
      saveActionHistory();

      populateRankingList(rankingSeatId);
      displayMessage(`✅ 順位登録モードでプレイヤー追加: ${decodedText}`);
      saveToLocalStorage();
      renderSeats();
    }

    function navigate(section) {
      document.getElementById('scanSection').style.display = (section === 'scan') ? 'block' : 'none';
      document.getElementById('rankingSection').style.display = (section === 'ranking') ? 'block' : 'none';

      if (section === 'ranking') {
        isRankingMode = true;
        rankingSeatId = null;
        document.getElementById('rankingList').innerHTML = '';
        displayMessage('📋 座席QRを読み込んでください（順位登録モード）');
        startRankingCamera();
      } else {
        isRankingMode = false;
        stopRankingCamera();
        initCamera();
      }
    }

    function populateRankingList(seatId) {
      const list = document.getElementById('rankingList');
      list.innerHTML = '';
      (seatMap[seatId] || []).forEach(pid => {
        const li = document.createElement('li');
        li.textContent = pid;
        li.dataset.playerId = pid;
        li.draggable = true;
        list.appendChild(li);
      });
      makeListDraggable(list);
      displayMessage(`📋 座席 ${seatId} の順位を並び替えてください`);
    }

    function makeListDraggable(ul) {
      let dragging = null;

      ul.querySelectorAll('li').forEach(li => {
        li.ondragstart = () => {
          dragging = li;
          li.classList.add('dragging');
        };
        li.ondragend = () => {
          dragging = null;
          li.classList.remove('dragging');
        };
        li.ondragover = e => {
          e.preventDefault();
          const tgt = e.target;
          if (tgt && tgt !== dragging && tgt.nodeName === 'LI') {
            const rect = tgt.getBoundingClientRect();
            const after = (e.clientY - rect.top) > rect.height / 2;
            tgt.parentNode.insertBefore(dragging, after ? tgt.nextSibling : tgt);
          }
        };
      });
    }

    function confirmRanking() {
      if (!rankingSeatId) {
        alert('順位登録する座席を読み込んでください');
        return;
      }

      const ordered = Array.from(document.querySelectorAll('#rankingList li')).map(li => li.dataset.playerId);

      ordered.forEach((pid, i) => {
        if (playerData[pid]) playerData[pid].lastRank = i + 1;
      });

      calculateRate(ordered);
      displayMessage('✅ 順位を保存しました');
      saveToLocalStorage();
      renderSeats();

      stopRankingCamera();
      isRankingMode = false;
      rankingSeatId = null;
      navigate('scan');
    }

    function calculateRate(rankedIds) {
      rankedIds.forEach((pid, i) => {
        const p = playerData[pid];
        if (!p) return;

        const prevRank = p.lastRank ?? rankedIds.length;
        const diff = prevRank - (i + 1);

        let point = diff * 2;

        if (prevRank === 1 && i === rankedIds.length - 1) point = -8;
        if (prevRank === rankedIds.length && i === 0) point = 8;

        if (p.rate >= 80) point = Math.floor(point * 0.8);

        const topId = getTopRatedPlayerId();
        if (topId && p.rate <= playerData[topId].rate && (i + 1) < playerData[topId].lastRank) {
          point += 2;
        }

        p.bonus = point;
        p.rate = Math.max(30, p.rate + point);
      });

      assignTitles();
    }

    function assignTitles() {
      Object.values(playerData).forEach(p => p.title = null);
      Object.entries(playerData)
        .sort((a, b) => b[1].rate - a[1].rate)
        .slice(0, 3)
        .forEach(([pid], idx) => {
          playerData[pid].title = ['👑 王者', '🥈 挑戦者', '🥉 鬼気迫る者'][idx];
        });
    }

    function getTopRatedPlayerId() {
      let topId = null;
      let topRate = -Infinity;
      for (const [pid, pdata] of Object.entries(playerData)) {
        if (pdata.rate > topRate) {
          topRate = pdata.rate;
          topId = pid;
        }
      }
      return topId;
    }

    function renderSeats() {
      const seatList = document.getElementById('seatList');
      if (!seatList) return;
      seatList.innerHTML = '';

      Object.keys(seatMap).forEach(seatId => {
        const block = document.createElement('div');
        block.className = 'seat-block';

        const title = document.createElement('h3');
        title.textContent = `座席: ${seatId}`;
        const removeSeat = document.createElement('span');
        removeSeat.textContent = '✖';
        removeSeat.className = 'remove-button';
        removeSeat.style.cursor = 'pointer';
        removeSeat.onclick = () => {
          if (confirm(`座席 ${seatId} を削除しますか？`)) {
            actionHistory.push({ type: 'removeSeat', seatId, players: [...seatMap[seatId]] });
            saveActionHistory();
            delete seatMap[seatId];
            saveToLocalStorage();
            renderSeats();
          }
        };
        title.appendChild(removeSeat);
        block.appendChild(title);

        seatMap[seatId].forEach(pid => {
          const p = playerData[pid] || {};
          const rc = p.bonus ?? 0;

          const playerDiv = document.createElement('div');
          playerDiv.className = 'player-entry';

          playerDiv.innerHTML = `
            <div>
              <strong>${pid}</strong> (${p.nickname || '名無し'})
              ${p.title ? `<span class="title-badge title-${p.title.replace(/\s/g,'\\ ')}">${p.title}</span>` : ''}
            </div>
            <div>
              R: ${p.rate ?? '-'}
              <span class="rate-change ${
                rc > 0 ? 'rate-up' : rc < 0 ? 'rate-down' : 'rate-zero'
              }">${rc > 0 ? `+${rc}` : rc < 0 ? rc : ''}</span>
              <span class="remove-button" title="削除" style="margin-left:10px;">×</span>
            </div>
          `;

          playerDiv.querySelector('.remove-button').onclick = () => {
            if (confirm(`プレイヤー ${pid} を座席から削除しますか？`)) {
              actionHistory.push({ type: 'removePlayer', seatId, playerId: pid });
              saveActionHistory();
              seatMap[seatId] = seatMap[seatId].filter(x => x !== pid);
              saveToLocalStorage();
              renderSeats();
            }
          };

          block.appendChild(playerDiv);
        });

        seatList.appendChild(block);
      });
    }

    function saveToLocalStorage() {
      localStorage.setItem('seatMap', JSON.stringify(seatMap));
      localStorage.setItem('playerData', JSON.stringify(playerData));
      localStorage.setItem('actionHistory', JSON.stringify(actionHistory));
    }

    function loadFromLocalStorage() {
      try {
        seatMap = JSON.parse(localStorage.getItem('seatMap')) || {};
        playerData = JSON.parse(localStorage.getItem('playerData')) || {};
        actionHistory = JSON.parse(localStorage.getItem('actionHistory')) || [];
      } catch {
        seatMap = {};
        playerData = {};
        actionHistory = [];
      }
    }

    function saveActionHistory() {
      if (isSaving) return;
      isSaving = true;

      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ actionHistory })
      })
      .then(res => res.json())
      .then(data => {
        isSaving = false;
        displayMessage('✅ サーバーに保存しました');
      })
      .catch(err => {
        isSaving = false;
        console.error(err);
        displayMessage('❌ サーバー保存に失敗しました');
      });
    }

    async function loadActionHistoryFromServer() {
      const res = await fetch(GAS_URL);
      const json = await res.json();
      if (Array.isArray(json.actionHistory)) {
        actionHistory = json.actionHistory;
        // 再生して状態復元
        seatMap = {};
        playerData = {};
        for (const act of actionHistory) {
          if (act.type === 'addPlayer') {
            seatMap[act.seatId] ??= [];
            seatMap[act.seatId].push(act.playerId);
            playerData[act.playerId] ??= { nickname: act.playerId, rate: 50, lastRank: null, bonus: 0, title: null };
          }
          else if (act.type === 'removePlayer') {
            seatMap[act.seatId] = (seatMap[act.seatId] || []).filter(p => p !== act.playerId);
          }
          else if (act.type === 'removeSeat') {
            delete seatMap[act.seatId];
          }
        }
        assignTitles();
        renderSeats();
      }
    }

    function undoAction() {
      if (actionHistory.length === 0) {
        displayMessage('⚠ 元に戻す操作はありません');
        return;
      }
      actionHistory.pop();
      saveActionHistory();
      loadActionHistoryFromServer().then(() => {
        saveToLocalStorage();
        displayMessage('✅ 元に戻しました');
      });
    }

    function startPolling() {
      pollTimer = setInterval(() => {
        if (!isSaving) {
          loadActionHistoryFromServer();
        }
      }, POLL_INTERVAL_MS);
    }

    function setupEventHandlers() {
      const btns = document.querySelectorAll('#navButtons button');
      btns[0].onclick = () => navigate('scan');
      btns[1].onclick = () => navigate('ranking');
      btns[2].onclick = () => undoAction();

      document.querySelector('#actionButtons button:nth-child(1)').onclick = () => confirmRanking();
      document.querySelector('#actionButtons button:nth-child(2)').onclick = () => {
        navigate('scan');
      };
    }

    async function init() {
      loadFromLocalStorage();
      try {
        await loadActionHistoryFromServer();
      } catch (e) {
        console.warn('操作履歴の取得に失敗:', e);
      }
      renderSeats();
      displayMessage('📢 起動しました');
      await stopAllCameras();
      await initCamera();
      startPolling();
      setupEventHandlers();
      console.log('初期化完了', actionHistory);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
