<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒãƒæŠœãå¤§ä¼šç®¡ç†</title>
  <style>
    /* ====== CSS ã‚¹ã‚¿ã‚¤ãƒ« ====== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 10px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 5px;
    }
    #messageArea {
      text-align: center;
      padding: 5px;
      margin-bottom: 10px;
      background: #eef;
      border-radius: 5px;
      min-height: 24px;
      font-weight: bold;
      color: #004;
    }
    #navButtons {
      text-align: center;
      margin-bottom: 10px;
    }
    #navButtons button {
      margin: 0 5px;
      padding: 8px 15px;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #777;
      border-radius: 5px;
      background-color: #ddd;
      transition: background-color 0.3s ease;
    }
    #navButtons button:hover {
      background-color: #bbb;
    }
    /* ã‚«ãƒ¡ãƒ©è¡¨ç¤ºé ˜åŸŸ */
    #reader, #rankingReader {
      width: 320px;
      height: 320px;
      margin: 10px auto;
      border: 2px solid #555;
      border-radius: 8px;
      background-color: #222;
    }
    /* åº§å¸­ä¸€è¦§ */
    #seatList {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .seat-block {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 6px #ccc;
      min-width: 280px;
      max-width: 300px;
    }
    .seat-block h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .remove-button {
      color: red;
      font-weight: bold;
      cursor: pointer;
    }
    .player-entry {
      border-top: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .title-badge {
      margin-left: 6px;
      font-weight: bold;
      font-size: 0.8rem;
      padding: 2px 5px;
      border-radius: 4px;
      color: white;
    }
    .title-ğŸ‘‘\ ç‹è€… {
      background-color: gold;
    }
    .title-ğŸ¥ˆ\ æŒ‘æˆ¦è€… {
      background-color: silver;
    }
    .title-ğŸ¥‰\ é¬¼æ°—è¿«ã‚‹è€… {
      background-color: #cd7f32;
    }
    .rate-change {
      margin-left: 10px;
      font-weight: bold;
    }
    .rate-up {
      color: green;
    }
    .rate-down {
      color: red;
    }
    .rate-zero {
      color: gray;
    }
    /* é †ä½ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    #rankingSection {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #rankingList {
      list-style: none;
      padding: 0;
      margin: 10px auto;
      width: 280px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 6px #ccc;
      min-height: 50px;
    }
    #rankingList li {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      cursor: grab;
      user-select: none;
    }
    #rankingList li:last-child {
      border-bottom: none;
    }
    #rankingList li.dragging {
      opacity: 0.5;
    }
    /* æ“ä½œãƒœã‚¿ãƒ³ */
    #actionButtons {
      margin-top: 10px;
      text-align: center;
    }
    #actionButtons button {
      margin: 0 7px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #4285f4;
      color: white;
      transition: background-color 0.3s ease;
    }
    #actionButtons button:hover {
      background-color: #3367d6;
    }
  </style>
</head>
<body>
  <h1>ãƒãƒæŠœãå¤§ä¼šç®¡ç†</h1>
  <div id="messageArea"></div>

  <div id="navButtons">
    <button>ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰</button>
    <button>é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</button>
    <button>å…ƒã«æˆ»ã™ (Undo)</button>
  </div>

  <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ -->
  <section id="scanSection">
    <div id="reader"></div>
    <div id="seatList"></div>
  </section>

  <!-- é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ -->
  <section id="rankingSection">
    <div id="rankingReader"></div>
    <ul id="rankingList"></ul>
    <div id="actionButtons">
      <button>é †ä½ç¢ºå®š</button>
      <button>æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- html5-qrcode ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyItVPS9GN4ePrx6Jj20WagXRq2z73wEKOPKEn6dImrovIAwXoersSwUixxUJSpddU/exec';
    const POLL_INTERVAL_MS = 20000;
    const SCAN_COOLDOWN_MS = 1500;

    let pollTimer = null;
    let isSaving = false;
    let qrReader = null;
    let rankingQrReader = null;
    let qrActive = false;
    let rankingQrActive = false;
    let isRankingMode = false;
    let currentSeatId = null;
    let rankingSeatId = null;
    let lastScanTime = 0;
    let lastScannedText = '';
    let seatMap = {};
    let playerData = {};
    let actionHistory = [];
    let msgTimer = null;

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function displayMessage(msg) {
      const area = document.getElementById('messageArea');
      if (!area) return;
      area.textContent = msg;
      clearTimeout(msgTimer);
      msgTimer = setTimeout(() => { area.textContent = ''; }, 3000);
    }

    async function stopCamera() {
      if (qrReader && qrActive) {
        await qrReader.stop();
        qrReader.clear();
        qrReader = null;
        qrActive = false;
      }
    }

    async function stopRankingCamera() {
      if (rankingQrReader && rankingQrActive) {
        await rankingQrReader.stop();
        rankingQrReader.clear();
        rankingQrReader = null;
        rankingQrActive = false;
      }
    }

    async function stopAllCameras() {
      await stopCamera();
      await stopRankingCamera();
    }

    async function initCamera() {
      const qrRegion = document.getElementById('reader');
      if (!qrRegion) return;

      if (typeof Html5Qrcode === 'undefined') {
        console.error("Html5QrcodeãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
        displayMessage("QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }

      await stopAllCameras();

      try {
        qrReader = new Html5Qrcode("reader");
        await qrReader.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            handleScanSuccess(qrCodeMessage);
          },
          errorMessage => {}
        );
        qrActive = true;
        displayMessage('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼‰');
      } catch (err) {
        console.error("QRã‚³ãƒ¼ãƒ‰åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
        displayMessage("âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    async function startRankingCamera() {
      if (rankingQrActive) return;

      await stopAllCameras();

      rankingQrReader = new Html5Qrcode('rankingReader');
      rankingQrReader.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        decodedText => {
          if (decodedText.startsWith('table')) {
            rankingSeatId = decodedText;
            displayMessage(`âœ… åº§å¸­ ${decodedText} èª­ã¿å–ã‚ŠæˆåŠŸ`);
            populateRankingList(rankingSeatId);
          } else if (decodedText.startsWith('player')) {
            handleRankingMode(decodedText);
          } else {
            displayMessage('âš  åº§å¸­ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼QRã®ã¿æœ‰åŠ¹ã§ã™');
          }
        },
        errorMessage => {}
      ).then(() => {
        rankingQrActive = true;
        displayMessage('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ï¼ˆé †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰');
      }).catch(err => {
        console.error(err);
        displayMessage('âŒ é †ä½ç™»éŒ²ç”¨ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—');
      });
    }

    function handleScanSuccess(decodedText) {
      const now = Date.now();
      if (decodedText === lastScannedText && now - lastScanTime < SCAN_COOLDOWN_MS) {
        return;
      }
      lastScannedText = decodedText;
      lastScanTime = now;

      if (decodedText.startsWith('table')) {
        currentSeatId = decodedText;
        if (!seatMap[currentSeatId]) seatMap[currentSeatId] = [];
        displayMessage(`âœ… åº§å¸­ã‚»ãƒƒãƒˆ: ${currentSeatId}`);
      } else if (decodedText.startsWith('player')) {
        if (!currentSeatId) {
          displayMessage('âš  å…ˆã«åº§å¸­QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
          return;
        }
        if (seatMap[currentSeatId].includes(decodedText)) {
          displayMessage('âš  æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™');
          return;
        }
        if (seatMap[currentSeatId].length >= 6) {
          displayMessage('âš  ã“ã®åº§å¸­ã¯6äººã¾ã§ç™»éŒ²å¯èƒ½ã§ã™');
          return;
        }

        seatMap[currentSeatId].push(decodedText);
        playerData[decodedText] ??= { nickname: decodedText, rate: 50, lastRank: null, bonus: 0, title: null };
        actionHistory.push({ type: 'addPlayer', seatId: currentSeatId, playerId: decodedText });
        saveActionHistory();
        displayMessage(`âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ : ${decodedText}`);
        saveToLocalStorage();
        renderSeats();
      }
    }

    function handleRankingMode(decodedText) {
      if (!rankingSeatId) {
        displayMessage('âš  å…ˆã«åº§å¸­QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆé †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        return;
      }
      if (!decodedText.startsWith('player')) {
        displayMessage('âš  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼QRã‚³ãƒ¼ãƒ‰ã®ã¿æœ‰åŠ¹ã§ã™');
        return;
      }

      const players = seatMap[rankingSeatId] || [];
      if (players.includes(decodedText)) {
        displayMessage('âš  æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™');
        return;
      }
      if (players.length >= 6) {
        displayMessage('âš  ã“ã®åº§å¸­ã¯6äººã¾ã§ç™»éŒ²å¯èƒ½ã§ã™');
        return;
      }

      players.push(decodedText);
      seatMap[rankingSeatId] = players;

      playerData[decodedText] ??= { nickname: decodedText, rate: 50, lastRank: null, bonus: 0, title: null };
      actionHistory.push({ type: 'addPlayer', seatId: rankingSeatId, playerId: decodedText });
      saveActionHistory();

      populateRankingList(rankingSeatId);
      displayMessage(`âœ… é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ : ${decodedText}`);
      saveToLocalStorage();
      renderSeats();
    }

    function navigate(section) {
      document.getElementById('scanSection').style.display = (section === 'scan') ? 'block' : 'none';
      document.getElementById('rankingSection').style.display = (section === 'ranking') ? 'block' : 'none';

      if (section === 'ranking') {
        isRankingMode = true;
        rankingSeatId = null;
        document.getElementById('rankingList').innerHTML = '';
        displayMessage('ğŸ“‹ åº§å¸­QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆé †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        startRankingCamera();
      } else {
        isRankingMode = false;
        stopRankingCamera();
        initCamera();
      }
    }

    function populateRankingList(seatId) {
      const list = document.getElementById('rankingList');
      list.innerHTML = '';
      (seatMap[seatId] || []).forEach(pid => {
        const li = document.createElement('li');
        li.textContent = pid;
        li.dataset.playerId = pid;
        li.draggable = true;
        list.appendChild(li);
      });
      makeListDraggable(list);
      displayMessage(`ğŸ“‹ åº§å¸­ ${seatId} ã®é †ä½ã‚’ä¸¦ã³æ›¿ãˆã¦ãã ã•ã„`);
    }

    function makeListDraggable(ul) {
      let dragging = null;

      ul.querySelectorAll('li').forEach(li => {
        li.ondragstart = () => {
          dragging = li;
          li.classList.add('dragging');
        };
        li.ondragend = () => {
          dragging = null;
          li.classList.remove('dragging');
        };
        li.ondragover = e => {
          e.preventDefault();
          const tgt = e.target;
          if (tgt && tgt !== dragging && tgt.nodeName === 'LI') {
            const rect = tgt.getBoundingClientRect();
            const after = (e.clientY - rect.top) > rect.height / 2;
            tgt.parentNode.insertBefore(dragging, after ? tgt.nextSibling : tgt);
          }
        };
      });
    }

    function confirmRanking() {
      if (!rankingSeatId) {
        alert('é †ä½ç™»éŒ²ã™ã‚‹åº§å¸­ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        return;
      }

      const ordered = Array.from(document.querySelectorAll('#rankingList li')).map(li => li.dataset.playerId);

      ordered.forEach((pid, i) => {
        if (playerData[pid]) playerData[pid].lastRank = i + 1;
      });

      calculateRate(ordered);
      displayMessage('âœ… é †ä½ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      saveToLocalStorage();
      renderSeats();

      stopRankingCamera();
      isRankingMode = false;
      rankingSeatId = null;
      navigate('scan');
    }

    function calculateRate(rankedIds) {
      rankedIds.forEach((pid, i) => {
        const p = playerData[pid];
        if (!p) return;

        const prevRank = p.lastRank ?? rankedIds.length;
        const diff = prevRank - (i + 1);

        let point = diff * 2;

        if (prevRank === 1 && i === rankedIds.length - 1) point = -8;
        if (prevRank === rankedIds.length && i === 0) point = 8;

        if (p.rate >= 80) point = Math.floor(point * 0.8);

        const topId = getTopRatedPlayerId();
        if (topId && p.rate <= playerData[topId].rate && (i + 1) < playerData[topId].lastRank) {
          point += 2;
        }

        p.bonus = point;
        p.rate = Math.max(30, p.rate + point);
      });

      assignTitles();
    }

    function assignTitles() {
      Object.values(playerData).forEach(p => p.title = null);
      Object.entries(playerData)
        .sort((a, b) => b[1].rate - a[1].rate)
        .slice(0, 3)
        .forEach(([pid], idx) => {
          playerData[pid].title = ['ğŸ‘‘ ç‹è€…', 'ğŸ¥ˆ æŒ‘æˆ¦è€…', 'ğŸ¥‰ é¬¼æ°—è¿«ã‚‹è€…'][idx];
        });
    }

    function getTopRatedPlayerId() {
      let topId = null;
      let topRate = -Infinity;
      for (const [pid, pdata] of Object.entries(playerData)) {
        if (pdata.rate > topRate) {
          topRate = pdata.rate;
          topId = pid;
        }
      }
      return topId;
    }

    function renderSeats() {
      const seatList = document.getElementById('seatList');
      if (!seatList) return;
      seatList.innerHTML = '';

      Object.keys(seatMap).forEach(seatId => {
        const block = document.createElement('div');
        block.className = 'seat-block';

        const title = document.createElement('h3');
        title.textContent = `åº§å¸­: ${seatId}`;
        const removeSeat = document.createElement('span');
        removeSeat.textContent = 'âœ–';
        removeSeat.className = 'remove-button';
        removeSeat.style.cursor = 'pointer';
        removeSeat.onclick = () => {
          if (confirm(`åº§å¸­ ${seatId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            actionHistory.push({ type: 'removeSeat', seatId, players: [...seatMap[seatId]] });
            saveActionHistory();
            delete seatMap[seatId];
            saveToLocalStorage();
            renderSeats();
          }
        };
        title.appendChild(removeSeat);
        block.appendChild(title);

        seatMap[seatId].forEach(pid => {
          const p = playerData[pid] || {};
          const rc = p.bonus ?? 0;

          const playerDiv = document.createElement('div');
          playerDiv.className = 'player-entry';

          playerDiv.innerHTML = `
            <div>
              <strong>${pid}</strong> (${p.nickname || 'åç„¡ã—'})
              ${p.title ? `<span class="title-badge title-${p.title.replace(/\s/g,'\\ ')}">${p.title}</span>` : ''}
            </div>
            <div>
              R: ${p.rate ?? '-'}
              <span class="rate-change ${
                rc > 0 ? 'rate-up' : rc < 0 ? 'rate-down' : 'rate-zero'
              }">${rc > 0 ? `+${rc}` : rc < 0 ? rc : ''}</span>
              <span class="remove-button" title="å‰Šé™¤" style="margin-left:10px;">Ã—</span>
            </div>
          `;

          playerDiv.querySelector('.remove-button').onclick = () => {
            if (confirm(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${pid} ã‚’åº§å¸­ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
              actionHistory.push({ type: 'removePlayer', seatId, playerId: pid });
              saveActionHistory();
              seatMap[seatId] = seatMap[seatId].filter(x => x !== pid);
              saveToLocalStorage();
              renderSeats();
            }
          };

          block.appendChild(playerDiv);
        });

        seatList.appendChild(block);
      });
    }

    function saveToLocalStorage() {
      localStorage.setItem('seatMap', JSON.stringify(seatMap));
      localStorage.setItem('playerData', JSON.stringify(playerData));
      localStorage.setItem('actionHistory', JSON.stringify(actionHistory));
    }

    function loadFromLocalStorage() {
      try {
        seatMap = JSON.parse(localStorage.getItem('seatMap')) || {};
        playerData = JSON.parse(localStorage.getItem('playerData')) || {};
        actionHistory = JSON.parse(localStorage.getItem('actionHistory')) || [];
      } catch {
        seatMap = {};
        playerData = {};
        actionHistory = [];
      }
    }

    function saveActionHistory() {
      if (isSaving) return;
      isSaving = true;

      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ actionHistory })
      })
      .then(res => res.json())
      .then(data => {
        isSaving = false;
        displayMessage('âœ… ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã—ã¾ã—ãŸ');
      })
      .catch(err => {
        isSaving = false;
        console.error(err);
        displayMessage('âŒ ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }

    async function loadActionHistoryFromServer() {
      const res = await fetch(GAS_URL);
      const json = await res.json();
      if (Array.isArray(json.actionHistory)) {
        actionHistory = json.actionHistory;
        // å†ç”Ÿã—ã¦çŠ¶æ…‹å¾©å…ƒ
        seatMap = {};
        playerData = {};
        for (const act of actionHistory) {
          if (act.type === 'addPlayer') {
            seatMap[act.seatId] ??= [];
            seatMap[act.seatId].push(act.playerId);
            playerData[act.playerId] ??= { nickname: act.playerId, rate: 50, lastRank: null, bonus: 0, title: null };
          }
          else if (act.type === 'removePlayer') {
            seatMap[act.seatId] = (seatMap[act.seatId] || []).filter(p => p !== act.playerId);
          }
          else if (act.type === 'removeSeat') {
            delete seatMap[act.seatId];
          }
        }
        assignTitles();
        renderSeats();
      }
    }

    function undoAction() {
      if (actionHistory.length === 0) {
        displayMessage('âš  å…ƒã«æˆ»ã™æ“ä½œã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      actionHistory.pop();
      saveActionHistory();
      loadActionHistoryFromServer().then(() => {
        saveToLocalStorage();
        displayMessage('âœ… å…ƒã«æˆ»ã—ã¾ã—ãŸ');
      });
    }

    function startPolling() {
      pollTimer = setInterval(() => {
        if (!isSaving) {
          loadActionHistoryFromServer();
        }
      }, POLL_INTERVAL_MS);
    }

    function setupEventHandlers() {
      const btns = document.querySelectorAll('#navButtons button');
      btns[0].onclick = () => navigate('scan');
      btns[1].onclick = () => navigate('ranking');
      btns[2].onclick = () => undoAction();

      document.querySelector('#actionButtons button:nth-child(1)').onclick = () => confirmRanking();
      document.querySelector('#actionButtons button:nth-child(2)').onclick = () => {
        navigate('scan');
      };
    }

    async function init() {
      loadFromLocalStorage();
      try {
        await loadActionHistoryFromServer();
      } catch (e) {
        console.warn('æ“ä½œå±¥æ­´ã®å–å¾—ã«å¤±æ•—:', e);
      }
      renderSeats();
      displayMessage('ğŸ“¢ èµ·å‹•ã—ã¾ã—ãŸ');
      await stopAllCameras();
      await initCamera();
      startPolling();
      setupEventHandlers();
      console.log('åˆæœŸåŒ–å®Œäº†', actionHistory);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
